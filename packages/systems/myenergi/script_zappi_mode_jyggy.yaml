script:
  zappi_mode_jyggy:
    alias: Set charging mode for Zappi - Jyggy
    icon: mdi:car-electric
    description: Set charging mode for Zappi
    fields:
      mode:
        description: 'what charging mode? Fast, Eco, Eco+, Stopped'
        example: 'Fast'
    sequence:
      - service: shell_command.zappi_set_mode
        data:
          myenergi_serial: !secret myenergi_serial
          myenergi_password: !secret myenergi_password
          zappi_serial: !secret zappi_serial_jyggy
          zappi_mode: "{% set mapper = {'Fast':'1','Eco': '2','Eco+':'3','Stopped':'4'} %}{{mapper[mode]}}"
      - alias: repeat this
        repeat:
          sequence:
            - delay: 5         
            - service: homeassistant.update_entity
              entity_id: sensor.zappi_jyggy_cmt
          until: "{{ states('sensor.zappi_jyggy_cmt') != 'Pending' }}"
      - delay: 1
      - service: homeassistant.update_entity
        entity_id: sensor.zappi_jyggy                  
      - condition: state
        entity_id: sensor.zappi_jyggy_cmt
        state: 'Failed'
      - service: input_select.select_option
        data: 
          entity_id: input_select.zappi_jyggy_charge_mode
          option: "{{ states('sensor.zappi_jyggy') }}"           
      - service: telegram_bot.send_message
        data:
          target: !secret telegram_chat_id_bruce_and_sarah               
          message: >
            Zappi Jyggy failed to change to {{mode}}
                
            Currently set to {{ states('sensor.zappi_jyggy') }}
            
            Last Online at: {{ state_attr('sensor.zappi_jyggy','dat') + ' ' + state_attr('sensor.zappi_jyggy','tim') }}            
          inline_keyboard:
            - 'Fast:/jyggy_fast, Eco+:/jyggy_ecoplus'
            - 'Eco:/jyggy_eco, Stop:/jyggy_stop' 
            - 'Refresh:/jyggy_refresh, OK:/remove_keyboard'               
